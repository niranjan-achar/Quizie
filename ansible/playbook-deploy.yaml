---
# ============================================
# Ansible Playbook - Deploy Applications
# ============================================
# Purpose: Deploy Quizie app to Kubernetes cluster
# Install ArgoCD, set up ingress, apply manifests
#
# Run: ansible-playbook -i ansible/inventory.yaml ansible/playbook-deploy.yaml

- name: Deploy Quizie Application
  hosts: k8s_masters
  become: yes
  gather_facts: yes
  
  vars:
    kubeconfig: "/home/{{ ansible_user }}/.kube/config"
    quizie_namespace: quizie
    github_repo: "YOUR_GITHUB_USERNAME/Quizie"
    argocd_version: "v2.9.0"
  
  environment:
    KUBECONFIG: "{{ kubeconfig }}"
  
  tasks:
    # ============ INSTALL FLANNEL (CNI) ============
    - name: Install Flannel network plugin
      shell: |
        kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      become_user: "{{ ansible_user }}"
    
    # ============ CREATE NAMESPACE ============
    - name: Create quizie namespace
      kubernetes.core.k8s:
        name: "{{ quizie_namespace }}"
        api_version: v1
        kind: Namespace
        state: present
        kubeconfig: "{{ kubeconfig }}"
      become_user: "{{ ansible_user }}"
    
    # ============ INSTALL NGINX INGRESS ============
    - name: Add NGINX Helm repository
      shell: |
        helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
        helm repo update
      become_user: "{{ ansible_user }}"
    
    - name: Install NGINX Ingress Controller
      shell: |
        helm install ingress-nginx ingress-nginx/ingress-nginx \
          --namespace ingress-nginx \
          --create-namespace \
          --set controller.service.type=LoadBalancer
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      become_user: "{{ ansible_user }}"
      register: ingress_install
      failed_when:
        - ingress_install.rc != 0
        - "'already exists' not in ingress_install.stderr"
    
    # ============ INSTALL CERT-MANAGER (Optional but recommended) ============
    - name: Install cert-manager for HTTPS
      shell: |
        kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      become_user: "{{ ansible_user }}"
    
    - name: Wait for cert-manager to be ready
      shell: |
        kubectl wait --for=condition=ready pod \
        -l app.kubernetes.io/instance=cert-manager \
        -n cert-manager \
        --timeout=300s
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      become_user: "{{ ansible_user }}"
      ignore_errors: yes
    
    # ============ CREATE SECRETS ============
    - name: Create MongoDB secret
      shell: |
        kubectl create secret generic mongodb-secret \
        --from-literal=username=admin \
        --from-literal=password=YourSecurePasswordHere \
        -n {{ quizie_namespace }} \
        --dry-run=client -o yaml | kubectl apply -f -
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      become_user: "{{ ansible_user }}"
    
    - name: Create API secrets
      shell: |
        kubectl create secret generic api-secrets \
        --from-literal=grok-api-key=YOUR_GROK_API_KEY \
        --from-literal=jwt-secret=YOUR_JWT_SECRET_HERE \
        -n {{ quizie_namespace }} \
        --dry-run=client -o yaml | kubectl apply -f -
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      become_user: "{{ ansible_user }}"
    
    # ============ DEPLOY KUBERNETES MANIFESTS ============
    - name: Apply Kubernetes manifests
      shell: |
        kubectl apply -f k8s/namespace.yaml
        kubectl apply -f k8s/configmaps.yaml
        kubectl apply -f k8s/mongodb-statefulset.yaml
        kubectl apply -f k8s/services.yaml
        kubectl apply -f k8s/frontend-deployment.yaml
        kubectl apply -f k8s/backend-deployment.yaml
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      become_user: "{{ ansible_user }}"
      args:
        chdir: "/home/{{ ansible_user }}/Quizie"
    
    # ============ INSTALL ARGOCD ============
    - name: Create argocd namespace
      kubernetes.core.k8s:
        name: argocd
        api_version: v1
        kind: Namespace
        state: present
        kubeconfig: "{{ kubeconfig }}"
      become_user: "{{ ansible_user }}"
    
    - name: Install ArgoCD
      shell: |
        kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/{{ argocd_version }}/manifests/install.yaml
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      become_user: "{{ ansible_user }}"
    
    - name: Wait for ArgoCD to be ready
      shell: |
        kubectl wait --for=condition=available --timeout=300s \
        deployment/argocd-server -n argocd
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      become_user: "{{ ansible_user }}"
      ignore_errors: yes
    
    # ============ CONFIGURE ARGOCD ============
    - name: Get ArgoCD initial admin password
      shell: |
        kubectl -n argocd get secret argocd-initial-admin-secret \
        -o jsonpath="{.data.password}" | base64 -d
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      become_user: "{{ ansible_user }}"
      register: argocd_password
      ignore_errors: yes
    
    - name: Display ArgoCD password
      debug:
        msg: "ArgoCD Admin Password: {{ argocd_password.stdout }}"
    
    - name: Port-forward ArgoCD (background)
      shell: |
        kubectl port-forward svc/argocd-server -n argocd 8080:443 &
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      become_user: "{{ ansible_user }}"
      async: 1000
      poll: 0
    
    # ============ APPLY INGRESS ============
    - name: Apply Ingress rules
      shell: |
        kubectl apply -f k8s/ingress.yaml
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      become_user: "{{ ansible_user }}"
      args:
        chdir: "/home/{{ ansible_user }}/Quizie"
    
    # ============ VERIFY DEPLOYMENT ============
    - name: Check pod status
      shell: |
        kubectl get pods -n {{ quizie_namespace }}
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      become_user: "{{ ansible_user }}"
      register: pod_status
    
    - name: Display pod status
      debug:
        var: pod_status.stdout
    
    - name: Check services
      shell: |
        kubectl get svc -n {{ quizie_namespace }}
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      become_user: "{{ ansible_user }}"
      register: service_status
    
    - name: Display service status
      debug:
        var: service_status.stdout
    
    - name: Display LoadBalancer IP (for frontend)
      shell: |
        kubectl get svc frontend-service -n {{ quizie_namespace }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      become_user: "{{ ansible_user }}"
      register: lb_ip
      ignore_errors: yes
    
    - name: Show LoadBalancer IP
      debug:
        msg: "Access frontend at: http://{{ lb_ip.stdout }}"
